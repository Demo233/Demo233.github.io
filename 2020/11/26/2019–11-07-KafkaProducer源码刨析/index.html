<!-- build time:Thu Nov 26 2020 12:31:12 GMT+0000 (GMT) --><!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui"><meta name="renderer" content="webkit"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=no,email=no,adress=no"><meta name="theme-color" content="#000000"><meta http-equiv="window-target" content="_top"><title>Kafkaæºç åˆ¨æä¹‹Produerå‘é€æ¨¡å‹ï¼ˆä¸€ï¼‰ | zyh</title><meta name="description" content="kafkaæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼çš„æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œç›®å‰åº”ç”¨ååˆ†å¹¿æ³›ã€‚çœ‹æºç ä¸ä»…å¯ä»¥äº†è§£å…¶åº•å±‚çš„ç»†èŠ‚ï¼ŒåŒæ—¶ï¼Œåœ¨çœ‹ä»£ç æ—¶ï¼Œä¹Ÿèƒ½è·Ÿç€å¤§ç¥ä»¬å­¦åˆ°å¾ˆå¤šçš„ç¼–ç¨‹æŠ€å·§ã€‚ KafkaProducerçš„ä½¿ç”¨åœ¨Kafkaä¸­ï¼ŒClientç«¯æ˜¯ç”±Javaå®ç°çš„ï¼ŒServerç«¯æ˜¯Scalaå®ç°çš„ã€‚ä¸‹é¢æˆ‘ä»¬ä»Clientç«¯å¼€å§‹ï¼Œåˆ†æä¸€ä¸‹Kafakaä¸­çš„Produceræ¨¡å‹ã€‚å¼€å§‹ä¹‹å‰æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹æ€ä¹ˆå‘Topicä¸­ç”Ÿäº§æ•°æ®ã€‚1234567891"><meta name="keywords" content="kafka"><meta property="og:type" content="article"><meta property="og:title" content="Kafkaæºç åˆ¨æä¹‹Produerå‘é€æ¨¡å‹ï¼ˆä¸€ï¼‰"><meta property="og:url" content="yihao.ml/2020/11/26/2019â€“11-07-KafkaProduceræºç åˆ¨æ/index.html"><meta property="og:site_name" content="YIHAO&#39;S BLOG"><meta property="og:description" content="kafkaæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼çš„æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œç›®å‰åº”ç”¨ååˆ†å¹¿æ³›ã€‚çœ‹æºç ä¸ä»…å¯ä»¥äº†è§£å…¶åº•å±‚çš„ç»†èŠ‚ï¼ŒåŒæ—¶ï¼Œåœ¨çœ‹ä»£ç æ—¶ï¼Œä¹Ÿèƒ½è·Ÿç€å¤§ç¥ä»¬å­¦åˆ°å¾ˆå¤šçš„ç¼–ç¨‹æŠ€å·§ã€‚ KafkaProducerçš„ä½¿ç”¨åœ¨Kafkaä¸­ï¼ŒClientç«¯æ˜¯ç”±Javaå®ç°çš„ï¼ŒServerç«¯æ˜¯Scalaå®ç°çš„ã€‚ä¸‹é¢æˆ‘ä»¬ä»Clientç«¯å¼€å§‹ï¼Œåˆ†æä¸€ä¸‹Kafakaä¸­çš„Produceræ¨¡å‹ã€‚å¼€å§‹ä¹‹å‰æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹æ€ä¹ˆå‘Topicä¸­ç”Ÿäº§æ•°æ®ã€‚1234567891"><meta property="og:locale" content="default"><meta property="og:image" content="https://i.loli.net/2019/11/07/r4CtIEAcmhwN7xo.jpg"><meta property="og:image" content="https://i.loli.net/2019/11/07/bL3CzBcH7G1f2Pe.jpg"><meta property="og:updated_time" content="2020-11-26T12:30:41.019Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Kafkaæºç åˆ¨æä¹‹Produerå‘é€æ¨¡å‹ï¼ˆä¸€ï¼‰"><meta name="twitter:description" content="kafkaæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼çš„æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œç›®å‰åº”ç”¨ååˆ†å¹¿æ³›ã€‚çœ‹æºç ä¸ä»…å¯ä»¥äº†è§£å…¶åº•å±‚çš„ç»†èŠ‚ï¼ŒåŒæ—¶ï¼Œåœ¨çœ‹ä»£ç æ—¶ï¼Œä¹Ÿèƒ½è·Ÿç€å¤§ç¥ä»¬å­¦åˆ°å¾ˆå¤šçš„ç¼–ç¨‹æŠ€å·§ã€‚ KafkaProducerçš„ä½¿ç”¨åœ¨Kafkaä¸­ï¼ŒClientç«¯æ˜¯ç”±Javaå®ç°çš„ï¼ŒServerç«¯æ˜¯Scalaå®ç°çš„ã€‚ä¸‹é¢æˆ‘ä»¬ä»Clientç«¯å¼€å§‹ï¼Œåˆ†æä¸€ä¸‹Kafakaä¸­çš„Produceræ¨¡å‹ã€‚å¼€å§‹ä¹‹å‰æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹æ€ä¹ˆå‘Topicä¸­ç”Ÿäº§æ•°æ®ã€‚1234567891"><meta name="twitter:image" content="https://i.loli.net/2019/11/07/r4CtIEAcmhwN7xo.jpg"><link rel="canonical" href="yihao.ml/2020/11/26/2019â€“11-07-KafkaProduceræºç åˆ¨æ/index.html"><link rel="alternate" href="/atom.xml" title="YIHAO&#39;S BLOG" type="application/atom+xml"><link rel="icon" href="/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1.4.0/dist/gitalk.min.css"></head><body class="main-center" itemscope itemtype="http://schema.org/WebPage"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="slimContent"><div class="navbar-header"><div class="profile-block text-center"><a id="avatar" href="https://github.com/Demo233" target="_blank"><img class="img-circle img-rotate" src="/images/avatar.jpg" width="200" height="200"></a><h2 id="name" class="hidden-xs hidden-sm">zyh</h2><h3 id="title" class="hidden-xs hidden-sm hidden-md"></h3><small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Shanghai, China</small></div><div class="search" id="search-form-wrap"><form class="search-form sidebar-form"><div class="input-group"><input type="text" class="search-form-input form-control" placeholder="Search"> <span class="input-group-btn"><button type="submit" class="search-form-submit btn btn-flat" onclick="return!1"><i class="icon icon-search"></i></button></span></div></form><div class="ins-search"><div class="ins-search-mask"></div><div class="ins-search-container"><div class="ins-input-wrapper"><input type="text" class="ins-search-input" placeholder="Type something..." x-webkit-speech> <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">Ã—</span></button></div><div class="ins-section-wrapper"><div class="ins-section-container"></div></div></div></div></div><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button></div><nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation"><ul class="nav navbar-nav main-nav"><li class="menu-item menu-item-home"><a href="/."><i class="icon icon-home-fill"></i> <span class="menu-title">Home</span></a></li><li class="menu-item menu-item-archives"><a href="/archives"><i class="icon icon-archives-fill"></i> <span class="menu-title">Archives</span></a></li><li class="menu-item menu-item-categories"><a href="/categories"><i class="icon icon-folder"></i> <span class="menu-title">Categories</span></a></li><li class="menu-item menu-item-tags"><a href="/tags"><i class="icon icon-tags"></i> <span class="menu-title">Tags</span></a></li><li class="menu-item menu-item-repository"><a href="/repository"><i class="icon icon-project"></i> <span class="menu-title">Repository</span></a></li><li class="menu-item menu-item-links"><a href="/links"><i class="icon icon-friendship"></i> <span class="menu-title">Links</span></a></li><li class="menu-item menu-item-about"><a href="/about"><i class="icon icon-cup-fill"></i> <span class="menu-title">About</span></a></li></ul><ul class="social-links"><li><a href="https://github.com/Demo233" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li><li><a href="https://www.weibo.com/u/5592904662/home" target="_blank" title="Weibo" data-toggle="tooltip" data-placement="top"><i class="icon icon-weibo"></i></a></li><li><a href="https://twitter.com/cnnqjban521" target="_blank" title="Twitter" data-toggle="tooltip" data-placement="top"><i class="icon icon-twitter"></i></a></li><li><a href="https://www.facebook.com/yihao.zhao.7" target="_blank" title="Facebook" data-toggle="tooltip" data-placement="top"><i class="icon icon-facebook"></i></a></li><li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li></ul></nav></div></header><aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar"><div class="slimContent"><div class="widget"><h3 class="widget-title">Board</h3><div class="widget-body"><div id="board"><div class="content"><p>å…´è¶£ä¸äº‹ä¸šçš„ä¸€è‡´ä»¥åŠå©šå§»ä¸çˆ±æƒ…çš„ä¸€è‡´</p></div></div></div></div><div class="widget"><h3 class="widget-title">Categories</h3><div class="widget-body"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Autodesk/">Autodesk</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/å…¶ä»–/">å…¶ä»–</a><span class="category-list-count">19</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/åˆ†å¸ƒå¼/">åˆ†å¸ƒå¼</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/å‰ç«¯/">å‰ç«¯</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/åç«¯/">åç«¯</a><span class="category-list-count">26</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/å¤§æ•°æ®/">å¤§æ•°æ®</a><span class="category-list-count">46</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/å¾®æœåŠ¡/">å¾®æœåŠ¡</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/æœºå™¨å­¦ä¹ /">æœºå™¨å­¦ä¹ </a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/æ¸¸æˆå¼€å‘/">æ¸¸æˆå¼€å‘</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ç‰©è”ç½‘/">ç‰©è”ç½‘</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ç®—æ³•ä¸æ•°æ®ç»“æ„/">ç®—æ³•ä¸æ•°æ®ç»“æ„</a><span class="category-list-count">23</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ç¼–ç¨‹è¯­è¨€/">ç¼–ç¨‹è¯­è¨€</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/è‡ªåŠ¨åŒ–æµ‹è¯•/">è‡ªåŠ¨åŒ–æµ‹è¯•</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/è½¬è½½/">è½¬è½½</a><span class="category-list-count">1</span></li></ul></div></div><div class="widget"><h3 class="widget-title">Tags</h3><div class="widget-body"><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/ActiveMQ/">ActiveMQ</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Anaconda/">Anaconda</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Azkaban/">Azkaban</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/">C</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CDH/">CDH</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DataTable/">DataTable</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/">Docker</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Editor/">Editor</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/FFmpeg/">FFmpeg</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/FTP/">FTP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Flink/">Flink</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Flume/">Flume</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Forge/">Forge</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Git/">Git</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HBase/">HBase</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HDFS/">HDFS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hadoop/">Hadoop</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hbase/">Hbase</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hibernate/">Hibernate</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hive/">Hive</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hue/">Hue</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/InfluxDB/">InfluxDB</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JVM/">JVM</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Jekyll/">Jekyll</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kafka/">Kafka</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MapReduce/">MapReduce</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MatLab/">MatLab</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Maven/">Maven</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Minecraft/">Minecraft</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mybatis/">Mybatis</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NIO/">NIO</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NodeJS/">NodeJS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python3/">Python3</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/R/">R</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RPC/">RPC</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Raspberry-Pi/">Raspberry Pi</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/">Redis</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Scala/">Scala</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Selenium/">Selenium</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Shiro/">Shiro</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spark/">Spark</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring/">Spring</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Storm/">Storm</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Struts2/">Struts2</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ubuntu/">Ubuntu</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vue/">Vue</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WebSocket/">WebSocket</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Wow/">Wow</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Zookeeper/">Zookeeper</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ceph/">ceph</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hive/">hive</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/k-means/">k-means</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kafka/">kafka</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/zTree/">zTree</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/å›¾/">å›¾</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/é€’å½’/">é€’å½’</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/é—®é¢˜æ€»ç»“/">é—®é¢˜æ€»ç»“</a><span class="tag-list-count">13</span></li></ul></div></div><div class="widget"><h3 class="widget-title">Tag Cloud</h3><div class="widget-body tagcloud"><a href="/tags/ActiveMQ/" style="font-size:13px">ActiveMQ</a> <a href="/tags/Anaconda/" style="font-size:13px">Anaconda</a> <a href="/tags/Azkaban/" style="font-size:13px">Azkaban</a> <a href="/tags/C/" style="font-size:13px">C</a> <a href="/tags/CDH/" style="font-size:13.67px">CDH</a> <a href="/tags/DataTable/" style="font-size:13px">DataTable</a> <a href="/tags/Docker/" style="font-size:13.33px">Docker</a> <a href="/tags/Editor/" style="font-size:13px">Editor</a> <a href="/tags/FFmpeg/" style="font-size:13.17px">FFmpeg</a> <a href="/tags/FTP/" style="font-size:13px">FTP</a> <a href="/tags/Flink/" style="font-size:13px">Flink</a> <a href="/tags/Flume/" style="font-size:13.17px">Flume</a> <a href="/tags/Forge/" style="font-size:13px">Forge</a> <a href="/tags/Git/" style="font-size:13.17px">Git</a> <a href="/tags/HBase/" style="font-size:13px">HBase</a> <a href="/tags/HDFS/" style="font-size:13px">HDFS</a> <a href="/tags/Hadoop/" style="font-size:13.5px">Hadoop</a> <a href="/tags/Hbase/" style="font-size:13.33px">Hbase</a> <a href="/tags/Hibernate/" style="font-size:13px">Hibernate</a> <a href="/tags/Hive/" style="font-size:13.17px">Hive</a> <a href="/tags/Hue/" style="font-size:13px">Hue</a> <a href="/tags/InfluxDB/" style="font-size:13px">InfluxDB</a> <a href="/tags/JVM/" style="font-size:13px">JVM</a> <a href="/tags/Java/" style="font-size:13px">Java</a> <a href="/tags/Jekyll/" style="font-size:13.17px">Jekyll</a> <a href="/tags/Kafka/" style="font-size:13.17px">Kafka</a> <a href="/tags/Linux/" style="font-size:13px">Linux</a> <a href="/tags/MapReduce/" style="font-size:13.5px">MapReduce</a> <a href="/tags/MatLab/" style="font-size:13.17px">MatLab</a> <a href="/tags/Maven/" style="font-size:13.17px">Maven</a> <a href="/tags/Minecraft/" style="font-size:13px">Minecraft</a> <a href="/tags/Mybatis/" style="font-size:13px">Mybatis</a> <a href="/tags/NIO/" style="font-size:13px">NIO</a> <a href="/tags/NodeJS/" style="font-size:13px">NodeJS</a> <a href="/tags/Python3/" style="font-size:13.33px">Python3</a> <a href="/tags/R/" style="font-size:13.17px">R</a> <a href="/tags/RPC/" style="font-size:13px">RPC</a> <a href="/tags/Raspberry-Pi/" style="font-size:13.33px">Raspberry Pi</a> <a href="/tags/Redis/" style="font-size:13.33px">Redis</a> <a href="/tags/Scala/" style="font-size:13.33px">Scala</a> <a href="/tags/Selenium/" style="font-size:13px">Selenium</a> <a href="/tags/Shiro/" style="font-size:13px">Shiro</a> <a href="/tags/Spark/" style="font-size:13.67px">Spark</a> <a href="/tags/Spring/" style="font-size:13.33px">Spring</a> <a href="/tags/Storm/" style="font-size:13.33px">Storm</a> <a href="/tags/Struts2/" style="font-size:13px">Struts2</a> <a href="/tags/Ubuntu/" style="font-size:13.83px">Ubuntu</a> <a href="/tags/Vue/" style="font-size:13px">Vue</a> <a href="/tags/WebSocket/" style="font-size:13.17px">WebSocket</a> <a href="/tags/Wow/" style="font-size:13px">Wow</a> <a href="/tags/Zookeeper/" style="font-size:13px">Zookeeper</a> <a href="/tags/ceph/" style="font-size:13px">ceph</a> <a href="/tags/hive/" style="font-size:13px">hive</a> <a href="/tags/k-means/" style="font-size:13px">k-means</a> <a href="/tags/kafka/" style="font-size:13.17px">kafka</a> <a href="/tags/zTree/" style="font-size:13px">zTree</a> <a href="/tags/å›¾/" style="font-size:13.67px">å›¾</a> <a href="/tags/é€’å½’/" style="font-size:13.17px">é€’å½’</a> <a href="/tags/é—®é¢˜æ€»ç»“/" style="font-size:14px">é—®é¢˜æ€»ç»“</a></div></div><div class="widget"><h3 class="widget-title">Archive</h3><div class="widget-body"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a><span class="archive-list-count">22</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a><span class="archive-list-count">17</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a><span class="archive-list-count">5</span></li></ul></div></div><div class="widget"><h3 class="widget-title">Recent Posts</h3><div class="widget-body"><ul class="recent-post-list list-unstyled no-thumbnail"><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/ç®—æ³•ä¸æ•°æ®ç»“æ„/">ç®—æ³•ä¸æ•°æ®ç»“æ„</a></p><p class="item-title"><a href="/2020/11/26/2020å¹´11æœˆ24æ—¥22:58:10_é‚»æ¥è¡¨æœ‰å‘å›¾/" class="title">é‚»æ¥è¡¨æœ‰å‘å›¾</a></p><p class="item-date"><time datetime="2020-11-26T12:30:41.025Z" itemprop="datePublished">2020-11-26</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/ç®—æ³•ä¸æ•°æ®ç»“æ„/">ç®—æ³•ä¸æ•°æ®ç»“æ„</a></p><p class="item-title"><a href="/2020/11/26/2020å¹´11æœˆ22æ—¥14:11:18_é‚»æ¥çŸ©é˜µæœ‰å‘å›¾/" class="title">é‚»æ¥çŸ©é˜µæœ‰å‘å›¾</a></p><p class="item-date"><time datetime="2020-11-26T12:30:41.025Z" itemprop="datePublished">2020-11-26</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/ç®—æ³•ä¸æ•°æ®ç»“æ„/">ç®—æ³•ä¸æ•°æ®ç»“æ„</a></p><p class="item-title"><a href="/2020/11/26/2020å¹´11æœˆ21æ—¥23:02:20_æ·±åº¦ä¼˜å…ˆéå†ç®—æ³•/" class="title">æ·±åº¦ä¼˜å…ˆéå†ç®—æ³•</a></p><p class="item-date"><time datetime="2020-11-26T12:30:41.025Z" itemprop="datePublished">2020-11-26</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/å…¶ä»–/">å…¶ä»–</a></p><p class="item-title"><a href="/2020/11/26/2020å¹´11æœˆ15æ—¥14:11:53_ä½¿ç”¨dockeréƒ¨ç½²hadoop/" class="title">Dockeréƒ¨ç½²hadoop</a></p><p class="item-date"><time datetime="2020-11-26T12:30:41.024Z" itemprop="datePublished">2020-11-26</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/å…¶ä»–/">å…¶ä»–</a></p><p class="item-title"><a href="/2020/11/26/2020å¹´11æœˆ15æ—¥13:38:15_é«˜æ•ˆVIMç¼–è¾‘å™¨/" class="title">é«˜æ•ˆVIMç¼–è¾‘å™¨</a></p><p class="item-date"><time datetime="2020-11-26T12:30:41.024Z" itemprop="datePublished">2020-11-26</time></p></div></li></ul></div></div></div></aside><main class="main" role="main"><div class="content"><article id="post-2019â€“11-07-KafkaProduceræºç åˆ¨æ" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting"><div class="article-header"><h1 class="article-title" itemprop="name">Kafkaæºç åˆ¨æä¹‹Produerå‘é€æ¨¡å‹ï¼ˆä¸€ï¼‰</h1><div class="article-meta"><span class="article-date"><i class="icon icon-calendar-check"></i> <a href="/2020/11/26/2019â€“11-07-KafkaProduceræºç åˆ¨æ/" class="article-date"><time datetime="2020-11-26T12:30:41.018Z" itemprop="datePublished">2020-11-26</time></a></span> <span class="article-category"><i class="icon icon-folder"></i> <a class="article-category-link" href="/categories/å¤§æ•°æ®/">å¤§æ•°æ®</a></span> <span class="article-tag"><i class="icon icon-tags"></i> <a class="article-tag-link" href="/tags/kafka/">kafka</a></span> <span class="article-read hidden-xs"><i class="icon icon-eye-fill" aria-hidden="true"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></span> <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2020/11/26/2019â€“11-07-KafkaProduceræºç åˆ¨æ/#comments" class="article-comment-link">Comments</a></span></div></div><div class="article-entry marked-body" itemprop="articleBody"><p>kafkaæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼çš„æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œç›®å‰åº”ç”¨ååˆ†å¹¿æ³›ã€‚çœ‹æºç ä¸ä»…å¯ä»¥äº†è§£å…¶åº•å±‚çš„ç»†èŠ‚ï¼ŒåŒæ—¶ï¼Œåœ¨çœ‹ä»£ç æ—¶ï¼Œä¹Ÿèƒ½è·Ÿç€å¤§ç¥ä»¬å­¦åˆ°å¾ˆå¤šçš„ç¼–ç¨‹æŠ€å·§ã€‚</p><h3 id="kafkaproducerçš„ä½¿ç”¨"><a class="markdownIt-Anchor" href="#kafkaproducerçš„ä½¿ç”¨"></a> KafkaProducerçš„ä½¿ç”¨</h3><p>åœ¨Kafkaä¸­ï¼ŒClientç«¯æ˜¯ç”±Javaå®ç°çš„ï¼ŒServerç«¯æ˜¯Scalaå®ç°çš„ã€‚ä¸‹é¢æˆ‘ä»¬ä»Clientç«¯å¼€å§‹ï¼Œåˆ†æä¸€ä¸‹Kafakaä¸­çš„Produceræ¨¡å‹ã€‚å¼€å§‹ä¹‹å‰æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹æ€ä¹ˆå‘Topicä¸­ç”Ÿäº§æ•°æ®ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">import org.apache.kafka.clients.producer.KafkaProducer;</span><br><span class="line">import org.apache.kafka.clients.producer.ProducerRecord;</span><br><span class="line">import org.apache.kafka.clients.producer.Producer;</span><br><span class="line"></span><br><span class="line">import java.util.Properties;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Created by matt on 16/7/26.</span><br><span class="line"> */</span><br><span class="line">public class ProducerTest &#123;</span><br><span class="line">    private static String topicName;</span><br><span class="line">    private static int msgNum;</span><br><span class="line">    private static int key;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        Properties props = new Properties();</span><br><span class="line">        props.put(&quot;bootstrap.servers&quot;, &quot;127.0.0.1:9092,127.0.0.2:9092&quot;);</span><br><span class="line">        props.put(&quot;key.serializer&quot;,&quot;org.apache.kafka.common.serialization.StringSerializer&quot;);</span><br><span class="line">        props.put(&quot;value.serializer&quot;,&quot;org.apache.kafka.common.serialization.StringSerializer&quot;);</span><br><span class="line">        topicName = &quot;test&quot;;</span><br><span class="line">        msgNum = 10; // å‘é€çš„æ¶ˆæ¯æ•°</span><br><span class="line"></span><br><span class="line">        Producer&lt;String, String&gt; producer = new KafkaProducer&lt;&gt;(props);</span><br><span class="line">        for (int i = 0; i &lt; msgNum; i++) &#123;</span><br><span class="line">            String msg = i + &quot; This is matt&apos;s blog.&quot;;</span><br><span class="line">            producer.send(new ProducerRecord&lt;String, String&gt;(topicName, msg));</span><br><span class="line">        &#125;</span><br><span class="line">        producer.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢å¯ä»¥çœ‹åˆ°å¦‚ä½•å‘Topicä¸­ç”Ÿäº§æ•°æ®ï¼ŒKafkaåœ¨è¿™æ–¹é¢å°è£…çš„å¾ˆå¥½ï¼Œåªéœ€è¦ä¸¤æ­¥å°±å¯ä»¥å®Œæˆæ“ä½œï¼š</p><pre><code>1. åˆå§‹åŒ–KafkaProducerç±»
2. è°ƒç”¨sendæ¥å£å‘é€æ•°æ®
</code></pre><p>ä¸‹é¢å›´ç»•ç€sendæ¥å£å¼€å§‹å±•å¼€ã€‚</p><h3 id="kafkaproducerä¸­çš„sendæ–¹æ³•"><a class="markdownIt-Anchor" href="#kafkaproducerä¸­çš„sendæ–¹æ³•"></a> KafkaProducerä¸­çš„sendæ–¹æ³•</h3><p>ç”¨æˆ·ä½¿ç”¨producer.sendå‘é€æ•°æ®ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹send()çš„å®ç°</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">// å¼‚æ­¥å‘ä¸€ä¸ª topic å‘é€æ•°æ®</span><br><span class="line">@Override</span><br><span class="line">public Future&lt;RecordMetadata&gt; send(ProducerRecord&lt;K, V&gt; record) &#123;</span><br><span class="line">    return send(record, null);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// å‘ topic å¼‚æ­¥åœ°å‘é€æ•°æ®ï¼Œå½“å‘é€ç¡®è®¤åå”¤èµ·å›è°ƒå‡½æ•°</span><br><span class="line">@Override</span><br><span class="line">public Future&lt;RecordMetadata&gt; send(ProducerRecord&lt;K, V&gt; record, Callback callback) &#123;</span><br><span class="line">    // intercept the record, which can be potentially modified; this method does not throw exceptions</span><br><span class="line">    ProducerRecord&lt;K, V&gt; interceptedRecord = this.interceptors == null ? record : this.interceptors.onSend(record);</span><br><span class="line">    return doSend(interceptedRecord, callback);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥å£æœ€åä¼šèµ°ä¸€ä¸ªdoSend()æ–¹æ³•ï¼Œæ¥ç€è¿½è¿›å»</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">private Future&lt;RecordMetadata&gt; doSend(ProducerRecord&lt;K, V&gt; record, Callback callback) &#123;</span><br><span class="line">       TopicPartition tp = null;</span><br><span class="line">       try &#123;</span><br><span class="line">           // 1.ç¡®è®¤æ•°æ®è¦å‘é€åˆ°çš„ topic çš„ metadata æ˜¯å¯ç”¨çš„</span><br><span class="line">           ClusterAndWaitTime clusterAndWaitTime = waitOnMetadata(record.topic(), record.partition(), maxBlockTimeMs);</span><br><span class="line">           long remainingWaitMs = Math.max(0, maxBlockTimeMs - clusterAndWaitTime.waitedOnMetadataMs);</span><br><span class="line">           Cluster cluster = clusterAndWaitTime.cluster;</span><br><span class="line">           // 2.åºåˆ—åŒ– record çš„ key å’Œ value</span><br><span class="line">           byte[] serializedKey;</span><br><span class="line">           try &#123;</span><br><span class="line">               serializedKey = keySerializer.serialize(record.topic(), record.key());</span><br><span class="line">           &#125; catch (ClassCastException cce) &#123;</span><br><span class="line">               throw new SerializationException(&quot;Can&apos;t convert key of class &quot; + record.key().getClass().getName() +</span><br><span class="line">                       &quot; to class &quot; + producerConfig.getClass(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG).getName() +</span><br><span class="line">                       &quot; specified in key.serializer&quot;);</span><br><span class="line">           &#125;</span><br><span class="line">           byte[] serializedValue;</span><br><span class="line">           try &#123;</span><br><span class="line">               serializedValue = valueSerializer.serialize(record.topic(), record.value());</span><br><span class="line">           &#125; catch (ClassCastException cce) &#123;</span><br><span class="line">               throw new SerializationException(&quot;Can&apos;t convert value of class &quot; + record.value().getClass().getName() +</span><br><span class="line">                       &quot; to class &quot; + producerConfig.getClass(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG).getName() +</span><br><span class="line">                       &quot; specified in value.serializer&quot;);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           // 3. è·å–è¯¥ record çš„ partition çš„å€¼ï¼ˆå¯ä»¥æŒ‡å®š,ä¹Ÿå¯ä»¥æ ¹æ®ç®—æ³•è®¡ç®—ï¼‰</span><br><span class="line">           int partition = partition(record, serializedKey, serializedValue, cluster);</span><br><span class="line">           int serializedSize = Records.LOG_OVERHEAD + Record.recordSize(serializedKey, serializedValue);</span><br><span class="line">           ensureValidRecordSize(serializedSize); // record çš„å­—èŠ‚è¶…å‡ºé™åˆ¶æˆ–å¤§äºå†…å­˜é™åˆ¶æ—¶,å°±ä¼šæŠ›å‡º RecordTooLargeException å¼‚å¸¸</span><br><span class="line">           tp = new TopicPartition(record.topic(), partition);</span><br><span class="line">           long timestamp = record.timestamp() == null ? time.milliseconds() : record.timestamp(); // æ—¶é—´æˆ³</span><br><span class="line">           log.trace(&quot;Sending record &#123;&#125; with callback &#123;&#125; to topic &#123;&#125; partition &#123;&#125;&quot;, record, callback, record.topic(), partition);</span><br><span class="line">           Callback interceptCallback = this.interceptors == null ? callback : new InterceptorCallback&lt;&gt;(callback, this.interceptors, tp);</span><br><span class="line">           // 4. å‘ accumulator ä¸­è¿½åŠ æ•°æ®</span><br><span class="line">           RecordAccumulator.RecordAppendResult result = accumulator.append(tp, timestamp, serializedKey, serializedValue,interceptCallback, remainingWaitMs);</span><br><span class="line">           // 5. å¦‚æœ batch å·²ç»æ»¡äº†,å”¤é†’ sender çº¿ç¨‹å‘é€æ•°æ®</span><br><span class="line">           if (result.batchIsFull || result.newBatchCreated) &#123;</span><br><span class="line">               log.trace(&quot;Waking up the sender since topic &#123;&#125; partition &#123;&#125; is either full or getting a new batch&quot;,record.topic(),partition);</span><br><span class="line">               this.sender.wakeup();</span><br><span class="line">           &#125;</span><br><span class="line">           return result.future;</span><br><span class="line">       &#125; catch (ApiException e) &#123;</span><br><span class="line">           log.debug(&quot;Exception occurred during message send:&quot;, e);</span><br><span class="line">           if (callback != null)</span><br><span class="line">               callback.onCompletion(null, e);</span><br><span class="line">           this.errors.record();</span><br><span class="line">           if (this.interceptors != null)</span><br><span class="line">               this.interceptors.onSendError(record, tp, e);</span><br><span class="line">           return new FutureFailure(e);</span><br><span class="line">       &#125; catch (InterruptedException e) &#123;</span><br><span class="line">           this.errors.record();</span><br><span class="line">           if (this.i nterceptors != null)</span><br><span class="line">               this.interceptors.onSendError(record, tp, e);</span><br><span class="line">           throw new InterruptException(e);</span><br><span class="line">       &#125; catch (BufferExhaustedException e) &#123;</span><br><span class="line">           this.errors.record();</span><br><span class="line">           this.metrics.sensor(&quot;buffer-exhausted-records&quot;).record();</span><br><span class="line">           if (this.interceptors != null)</span><br><span class="line">               this.interceptors.onSendError(record, tp, e);</span><br><span class="line">           throw e;</span><br><span class="line">       &#125; catch (KafkaException e) &#123;</span><br><span class="line">           this.errors.record();</span><br><span class="line">           if (this.interceptors != null)</span><br><span class="line">               this.interceptors.onSendError(record, tp, e);</span><br><span class="line">           throw e;</span><br><span class="line">       &#125; catch (Exception e) &#123;</span><br><span class="line">           if (this.interceptors != null)</span><br><span class="line">               this.interceptors.onSendError(record, tp, e);</span><br><span class="line">           throw e;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ dosend() æ–¹æ³•çš„å®ç°ä¸Šï¼Œä¸€æ¡ Record æ•°æ®çš„å‘é€ï¼Œå¯ä»¥åˆ†ä¸ºä»¥ä¸‹äº”æ­¥ï¼š</p><pre><code>1. ç¡®è®¤æ•°æ®è¦å‘é€åˆ°çš„ topic çš„ metadata æ˜¯å¯ç”¨çš„ï¼ˆå¦‚æœè¯¥ partition çš„ leader å­˜åœ¨åˆ™æ˜¯å¯ç”¨çš„ï¼Œå¦‚æœå¼€å¯æƒé™æ—¶ï¼Œclient æœ‰ç›¸åº”çš„æƒé™ï¼‰ï¼Œå¦‚æœæ²¡æœ‰ topic çš„ metadata ä¿¡æ¯ï¼Œå°±éœ€è¦è·å–ç›¸åº”çš„ metadataï¼›
2. åºåˆ—åŒ– record çš„ key å’Œ valueï¼›
3. è·å–è¯¥ record è¦å‘é€åˆ°çš„ partitionï¼ˆå¯ä»¥æŒ‡å®šï¼Œä¹Ÿå¯ä»¥æ ¹æ®ç®—æ³•è®¡ç®—ï¼‰ï¼›
4. å‘ accumulator ä¸­è¿½åŠ  record æ•°æ®ï¼Œæ•°æ®ä¼šå…ˆè¿›è¡Œç¼“å­˜ï¼›
5. å¦‚æœè¿½åŠ å®Œæ•°æ®åï¼Œå¯¹åº”çš„ RecordBatch å·²ç»è¾¾åˆ°äº† batch.size çš„å¤§å°ï¼ˆæˆ–è€…batch çš„å‰©ä½™ç©ºé—´ä¸è¶³ä»¥æ·»åŠ ä¸‹ä¸€æ¡ Recordï¼‰ï¼Œåˆ™å”¤é†’ sender çº¿ç¨‹å‘é€æ•°æ®ã€‚
</code></pre><p>æ•°æ®çš„å‘é€è¿‡ç¨‹ï¼Œå¯ä»¥ç®€å•æ€»ç»“ä¸ºä»¥ä¸Šäº”ç‚¹ï¼Œä¸‹é¢ä¼šè¿™å‡ éƒ¨åˆ†çš„å…·ä½“å®ç°è¿›è¡Œè¯¦ç»†åˆ†æã€‚</p><h2 id="å‘é€çš„è¿‡ç¨‹è¯¦è§£"><a class="markdownIt-Anchor" href="#å‘é€çš„è¿‡ç¨‹è¯¦è§£"></a> å‘é€çš„è¿‡ç¨‹è¯¦è§£</h2><h3 id="è·å–-topic-çš„-metadata-ä¿¡æ¯"><a class="markdownIt-Anchor" href="#è·å–-topic-çš„-metadata-ä¿¡æ¯"></a> è·å– topic çš„ metadata ä¿¡æ¯</h3><p>Producer é€šè¿‡ waitOnMetadata() æ–¹æ³•æ¥è·å–å¯¹åº” topic çš„ metadata ä¿¡æ¯ï¼Œè¿™éƒ¨åˆ†åé¢ä¼šå•ç‹¬æŠ½å‡ºä¸€ç¯‡æ–‡ç« æ¥ä»‹ç»ï¼Œè¿™é‡Œå°±ä¸å†è¯¦è¿°ï¼Œæ€»ç»“èµ·æ¥å°±æ˜¯ï¼šåœ¨æ•°æ®å‘é€å‰ï¼Œéœ€è¦å…ˆè¯¥ topic æ˜¯å¯ç”¨çš„ã€‚</p><h3 id="key-å’Œ-value-çš„åºåˆ—åŒ–"><a class="markdownIt-Anchor" href="#key-å’Œ-value-çš„åºåˆ—åŒ–"></a> key å’Œ value çš„åºåˆ—åŒ–</h3><p>Producer ç«¯å¯¹ record çš„ key å’Œ value å€¼è¿›è¡Œåºåˆ—åŒ–æ“ä½œï¼Œåœ¨ Consumer ç«¯å†è¿›è¡Œç›¸åº”çš„ååºåˆ—åŒ–ï¼ŒKafka å†…éƒ¨æä¾›çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ç®—æ³•å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://i.loli.net/2019/11/07/r4CtIEAcmhwN7xo.jpg" alt="D8B532DC-1C96-4778-875F-2466E5835EFA.jpeg"><br>Need support? Please accept cookies and refresh the page ğŸ˜ƒ</p><p>Kafka serialize &amp; deserialize</p><p>å½“ç„¶æˆ‘ä»¬ä¹Ÿæ˜¯å¯ä»¥è‡ªå®šä¹‰åºåˆ—åŒ–çš„å…·ä½“å®ç°ï¼Œä¸è¿‡ä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒKafka å†…éƒ¨æä¾›çš„è¿™äº›æ–¹æ³•å·²ç»è¶³å¤Ÿä½¿ç”¨ã€‚</p><h3 id="è·å–-partition-å€¼"><a class="markdownIt-Anchor" href="#è·å–-partition-å€¼"></a> è·å– partition å€¼</h3><p>å…³äº partition å€¼çš„è®¡ç®—ï¼Œåˆ†ä¸ºä¸‰ç§æƒ…å†µï¼š</p><p>æŒ‡æ˜ partition çš„æƒ…å†µä¸‹ï¼Œç›´æ¥å°†æŒ‡æ˜çš„å€¼ç›´æ¥ä½œä¸º partiton å€¼ï¼›<br>æ²¡æœ‰æŒ‡æ˜ partition å€¼ä½†æœ‰ key çš„æƒ…å†µä¸‹ï¼Œå°† key çš„ hash å€¼ä¸ topic çš„ partition æ•°è¿›è¡Œå–ä½™å¾—åˆ° partition å€¼ï¼›<br>æ—¢æ²¡æœ‰ partition å€¼åˆæ²¡æœ‰ key å€¼çš„æƒ…å†µä¸‹ï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶éšæœºç”Ÿæˆä¸€ä¸ªæ•´æ•°ï¼ˆåé¢æ¯æ¬¡è°ƒç”¨åœ¨è¿™ä¸ªæ•´æ•°ä¸Šè‡ªå¢ï¼‰ï¼Œå°†è¿™ä¸ªå€¼ä¸ topic å¯ç”¨çš„ partition æ€»æ•°å–ä½™å¾—åˆ° partition å€¼ï¼Œä¹Ÿå°±æ˜¯å¸¸è¯´çš„ round-robin ç®—æ³•ã€‚<br>å…·ä½“å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// å½“ record ä¸­æœ‰ partition å€¼æ—¶ï¼Œç›´æ¥è¿”å›ï¼Œæ²¡æœ‰çš„æƒ…å†µä¸‹è°ƒç”¨ partitioner çš„ç±»çš„ partition æ–¹æ³•å»è®¡ç®—ï¼ˆKafkaProducer.classï¼‰</span><br><span class="line">private int partition(ProducerRecord&lt;K, V&gt; record, byte[] serializedKey, byte[] serializedValue, Cluster cluster) &#123;</span><br><span class="line">    Integer partition = record.partition();</span><br><span class="line">    return partition != null ?</span><br><span class="line">            partition :</span><br><span class="line">            partitioner.partition(</span><br><span class="line">                    record.topic(), record.key(), serializedKey, record.value(), serializedValue, cluster);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Producer é»˜è®¤ä½¿ç”¨çš„<code>partitioner</code>æ˜¯<code>org.apache.kafka.clients.producer.internals.DefaultPartitioner</code>ï¼Œç”¨æˆ·ä¹Ÿå¯ä»¥è‡ªå®šä¹‰ partition çš„ç­–ç•¥ï¼Œä¸‹é¢æ˜¯è¿™ä¸ªç±»ä¸¤ä¸ªæ–¹æ³•çš„å…·ä½“å®ç°ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">public int partition(String topic, Object key, byte[] keyBytes, Object value, byte[] valueBytes, Cluster cluster) &#123;</span><br><span class="line">        List&lt;PartitionInfo&gt; partitions = cluster.partitionsForTopic(topic);</span><br><span class="line">        int numPartitions = partitions.size();</span><br><span class="line">        if (keyBytes == null) &#123;// æ²¡æœ‰æŒ‡å®š key çš„æƒ…å†µä¸‹</span><br><span class="line">            int nextValue = nextValue(topic); // ç¬¬ä¸€æ¬¡çš„æ—¶å€™äº§ç”Ÿä¸€ä¸ªéšæœºæ•´æ•°,åé¢æ¯æ¬¡è°ƒç”¨åœ¨ä¹‹å‰çš„åŸºç¡€ä¸Šè‡ªå¢;</span><br><span class="line">            List&lt;PartitionInfo&gt; availablePartitions = cluster.availablePartitionsForTopic(topic);</span><br><span class="line">            // leader ä¸ä¸º null,å³ä¸ºå¯ç”¨çš„ partition</span><br><span class="line">            if (availablePartitions.size() &gt; 0) &#123;</span><br><span class="line">                int part = Utils.toPositive(nextValue) % availablePartitions.size();</span><br><span class="line">                return availablePartitions.get(part).partition();</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                return Utils.toPositive(nextValue) % numPartitions;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;// æœ‰ key çš„æƒ…å†µä¸‹,ä½¿ç”¨ key çš„ hash å€¼è¿›è¡Œè®¡ç®—</span><br><span class="line">            return Utils.toPositive(Utils.murmur2(keyBytes)) % numPartitions; // é€‰æ‹© key çš„ hash å€¼</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // æ ¹æ® topic è·å–å¯¹åº”çš„æ•´æ•°å˜é‡</span><br><span class="line">    private int nextValue(String topic) &#123;</span><br><span class="line">        AtomicInteger counter = topicCounterMap.get(topic);</span><br><span class="line">        if (null == counter) &#123; // ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶ï¼Œéšæœºäº§ç”Ÿ</span><br><span class="line">            counter = new AtomicInteger(new Random().nextInt());</span><br><span class="line">            AtomicInteger currentCounter = topicCounterMap.putIfAbsent(topic, counter);</span><br><span class="line">            if (currentCounter != null) &#123;</span><br><span class="line">                counter = currentCounter;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return counter.getAndIncrement(); // åé¢å†è°ƒç”¨æ—¶ï¼Œæ ¹æ®ä¹‹å‰çš„ç»“æœè‡ªå¢</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™å°±æ˜¯ Producer ä¸­é»˜è®¤çš„ partitioner å®ç°ã€‚</p><h3 id="å‘-accumulator-å†™æ•°æ®"><a class="markdownIt-Anchor" href="#å‘-accumulator-å†™æ•°æ®"></a> å‘ accumulator å†™æ•°æ®</h3><p>Producer ä¼šå…ˆå°† record å†™å…¥åˆ° buffer ä¸­ï¼Œå½“è¾¾åˆ°ä¸€ä¸ª batch.size çš„å¤§å°æ—¶ï¼Œå†å”¤èµ· sender çº¿ç¨‹å»å‘é€ RecordBatchï¼ˆç¬¬äº”æ­¥ï¼‰ï¼Œè¿™é‡Œå…ˆè¯¦ç»†åˆ†æä¸€ä¸‹ Producer æ˜¯å¦‚ä½•å‘ buffer ä¸­å†™å…¥æ•°æ®çš„ã€‚</p><p>Producer æ˜¯é€šè¿‡ RecordAccumulator å®ä¾‹è¿½åŠ æ•°æ®ï¼ŒRecordAccumulator æ¨¡å‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œä¸€ä¸ªé‡è¦çš„å˜é‡å°±æ˜¯ ConcurrentMap&lt;TopicPartition, Deque<recordbatch>&gt; batchesï¼Œæ¯ä¸ª TopicPartition éƒ½ä¼šå¯¹åº”ä¸€ä¸ª Deque<recordbatch>ï¼Œå½“æ·»åŠ æ•°æ®æ—¶ï¼Œä¼šå‘å…¶ topic-partition å¯¹åº”çš„è¿™ä¸ª queue æœ€æ–°åˆ›å»ºçš„ä¸€ä¸ª RecordBatch ä¸­æ·»åŠ  recordï¼Œè€Œå‘é€æ•°æ®æ—¶ï¼Œåˆ™ä¼šå…ˆä» queue ä¸­æœ€è€çš„é‚£ä¸ª RecordBatch å¼€å§‹å‘é€ã€‚</recordbatch></recordbatch></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![C89D1394-08D6-416D-814D-BC19D65091B2.jpeg](https://i.loli.net/2019/11/07/C6bS5ieDGfnAOsg.jpg)</span><br></pre></td></tr></table></figure><p>Producer RecordAccumulator æ¨¡å‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">// org.apache.kafka.clients.producer.internals.RecordAccumulator</span><br><span class="line">     // å‘ accumulator æ·»åŠ ä¸€æ¡ recordï¼Œå¹¶è¿”å›æ·»åŠ åçš„ç»“æœï¼ˆç»“æœä¸»è¦åŒ…å«: future metadataã€batch æ˜¯å¦æ»¡çš„æ ‡å¿—ä»¥åŠæ–° batch æ˜¯å¦åˆ›å»ºï¼‰å…¶ä¸­ï¼Œ maxTimeToBlock æ˜¯ buffer.memory çš„ block çš„æœ€å¤§æ—¶é—´</span><br><span class="line">    public RecordAppendResult append(TopicPartition tp,</span><br><span class="line">                                     long timestamp,</span><br><span class="line">                                     byte[] key,</span><br><span class="line">                                     byte[] value,</span><br><span class="line">                                     Callback callback,</span><br><span class="line">                                     long maxTimeToBlock) throws InterruptedException &#123;</span><br><span class="line">        appendsInProgress.incrementAndGet();</span><br><span class="line">        try &#123;</span><br><span class="line">            Deque&lt;RecordBatch&gt; dq = getOrCreateDeque(tp);// æ¯ä¸ª topicPartition å¯¹åº”ä¸€ä¸ª queue</span><br><span class="line">            synchronized (dq) &#123;// åœ¨å¯¹ä¸€ä¸ª queue è¿›è¡Œæ“ä½œæ—¶,ä¼šä¿è¯çº¿ç¨‹å®‰å…¨</span><br><span class="line">                if (closed)</span><br><span class="line">                    throw new IllegalStateException(&quot;Cannot send after the producer is closed.&quot;);</span><br><span class="line">                RecordAppendResult appendResult = tryAppend(timestamp, key, value, callback, dq); // è¿½åŠ æ•°æ®</span><br><span class="line">                if (appendResult != null)// è¿™ä¸ª topic-partition å·²ç»æœ‰è®°å½•äº†</span><br><span class="line">                    return appendResult;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // ä¸º topic-partition åˆ›å»ºä¸€ä¸ªæ–°çš„ RecordBatch, éœ€è¦åˆå§‹åŒ–ç›¸åº”çš„ RecordBatchï¼Œè¦ä¸ºå…¶åˆ†é…çš„å¤§å°æ˜¯: maxï¼ˆbatch.size, åŠ ä¸Šå¤´æ–‡ä»¶çš„æœ¬æ¡æ¶ˆæ¯çš„å¤§å°ï¼‰</span><br><span class="line">            int size = Math.max(this.batchSize, Records.LOG_OVERHEAD + Record.recordSize(key, value));</span><br><span class="line">            log.trace(&quot;Allocating a new &#123;&#125; byte message buffer for topic &#123;&#125; partition &#123;&#125;&quot;, size, tp.topic(), tp.partition());</span><br><span class="line">            ByteBuffer buffer = free.allocate(size, maxTimeToBlock);// ç»™è¿™ä¸ª RecordBatch åˆå§‹åŒ–ä¸€ä¸ª buffer</span><br><span class="line">            synchronized (dq) &#123;</span><br><span class="line">                if (closed)</span><br><span class="line">                    throw new IllegalStateException(&quot;Cannot send after the producer is closed.&quot;);</span><br><span class="line"></span><br><span class="line">                RecordAppendResult appendResult = tryAppend(timestamp, key, value, callback, dq);</span><br><span class="line">                if (appendResult != null) &#123;// å¦‚æœçªç„¶å‘ç°è¿™ä¸ª queue å·²ç»å­˜åœ¨ï¼Œé‚£ä¹ˆå°±é‡Šæ”¾è¿™ä¸ªå·²ç»åˆ†é…çš„ç©ºé—´</span><br><span class="line">                    free.deallocate(buffer);</span><br><span class="line">                    return appendResult;</span><br><span class="line">                &#125;</span><br><span class="line">                // ç»™ topic-partition åˆ›å»ºä¸€ä¸ª RecordBatch</span><br><span class="line">                MemoryRecordsBuilder recordsBuilder = MemoryRecords.builder(buffer, compression, TimestampType.CREATE_TIME, this.batchSize);</span><br><span class="line">                RecordBatch batch = new RecordBatch(tp, recordsBuilder, time.milliseconds());</span><br><span class="line">                // å‘æ–°çš„ RecordBatch ä¸­è¿½åŠ æ•°æ®</span><br><span class="line">                FutureRecordMetadata future = Utils.notNull(batch.tryAppend(timestamp, key, value, callback, time.milliseconds()));</span><br><span class="line"></span><br><span class="line">                dq.addLast(batch);// å°† RecordBatch æ·»åŠ åˆ°å¯¹åº”çš„ queue ä¸­</span><br><span class="line">                incomplete.add(batch);// å‘æœª ack çš„ batch é›†åˆæ·»åŠ è¿™ä¸ª batch</span><br><span class="line">                // å¦‚æœ dp.size()&gt;1 å°±è¯æ˜è¿™ä¸ª queue æœ‰ä¸€ä¸ª batch æ˜¯å¯ä»¥å‘é€äº†</span><br><span class="line">                return new RecordAppendResult(future, dq.size() &gt; 1 || batch.isFull(), true);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            appendsInProgress.decrementAndGet();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æ€»ç»“ä¸€ä¸‹å…¶ record å†™å…¥çš„å…·ä½“æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://i.loli.net/2019/11/07/bL3CzBcH7G1f2Pe.jpg" alt="2EC40DD6-2B51-4F00-B2C7-CB6242E47B8F.jpeg"></p><p>Producer RecordAccumulator record å†™å…¥æµç¨‹</p><p>è·å–è¯¥ topic-partition å¯¹åº”çš„ queueï¼Œæ²¡æœ‰çš„è¯ä¼šåˆ›å»ºä¸€ä¸ªç©ºçš„ queueï¼›<br>å‘ queue ä¸­è¿½åŠ æ•°æ®ï¼Œå…ˆè·å– queue ä¸­æœ€æ–°åŠ å…¥çš„é‚£ä¸ª RecordBatchï¼Œå¦‚æœä¸å­˜åœ¨æˆ–è€…å­˜åœ¨ä½†å‰©ä½™ç©ºä½™ä¸è¶³ä»¥æ·»åŠ æœ¬æ¡ record åˆ™è¿”å› nullï¼ŒæˆåŠŸå†™å…¥çš„è¯ç›´æ¥è¿”å›ç»“æœï¼Œå†™å…¥æˆåŠŸï¼›<br>åˆ›å»ºä¸€ä¸ªæ–°çš„ RecordBatchï¼Œåˆå§‹åŒ–å†…å­˜å¤§å°æ ¹æ® max(batch.size, Records.LOG_OVERHEAD + Record.recordSize(key, value)) æ¥ç¡®å®šï¼ˆé˜²æ­¢å•æ¡ record è¿‡å¤§çš„æƒ…å†µï¼‰ï¼›<br>å‘æ–°å»ºçš„ RecordBatch å†™å…¥ recordï¼Œå¹¶å°† RecordBatch æ·»åŠ åˆ° queue ä¸­ï¼Œè¿”å›ç»“æœï¼Œå†™å…¥æˆåŠŸã€‚</p><h3 id="å‘é€-recordbatch"><a class="markdownIt-Anchor" href="#å‘é€-recordbatch"></a> å‘é€ RecordBatch</h3><p>å½“ record å†™å…¥æˆåŠŸåï¼Œå¦‚æœå‘ç° RecordBatch å·²æ»¡è¶³å‘é€çš„æ¡ä»¶ï¼ˆé€šå¸¸æ˜¯ queue ä¸­æœ‰å¤šä¸ª batchï¼Œé‚£ä¹ˆæœ€å…ˆæ·»åŠ çš„é‚£äº› batch è‚¯å®šæ˜¯å¯ä»¥å‘é€äº†ï¼‰ï¼Œé‚£ä¹ˆå°±ä¼šå”¤é†’ sender çº¿ç¨‹ï¼Œå‘é€ RecordBatchã€‚</p><p>sender çº¿ç¨‹å¯¹ RecordBatch çš„å¤„ç†æ˜¯åœ¨ run() æ–¹æ³•ä¸­è¿›è¡Œçš„ï¼Œè¯¥æ–¹æ³•å…·ä½“å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">void run(long now) &#123;</span><br><span class="line">        Cluster cluster = metadata.fetch();</span><br><span class="line">        // è·å–é‚£äº›å·²ç»å¯ä»¥å‘é€çš„ RecordBatch å¯¹åº”çš„ nodes</span><br><span class="line">        RecordAccumulator.ReadyCheckResult result = this.accumulator.ready(cluster, now);</span><br><span class="line"></span><br><span class="line">        // å¦‚æœæœ‰ topic-partition çš„ leader æ˜¯æœªçŸ¥çš„,å°±å¼ºåˆ¶ metadata æ›´æ–°</span><br><span class="line">        if (!result.unknownLeaderTopics.isEmpty()) &#123;</span><br><span class="line">            for (String topic : result.unknownLeaderTopics)</span><br><span class="line">                this.metadata.add(topic);</span><br><span class="line">            this.metadata.requestUpdate();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // å¦‚æœä¸node æ²¡æœ‰è¿æ¥ï¼ˆå¦‚æœå¯ä»¥è¿æ¥,åŒæ—¶åˆå§‹åŒ–è¯¥è¿æ¥ï¼‰,å°±è¯æ˜è¯¥ node æš‚æ—¶ä¸èƒ½å‘é€æ•°æ®,æš‚æ—¶ç§»é™¤è¯¥ node</span><br><span class="line">        Iterator&lt;Node&gt; iter = result.readyNodes.iterator();</span><br><span class="line">        long notReadyTimeout = Long.MAX_VALUE;</span><br><span class="line">        while (iter.hasNext()) &#123;</span><br><span class="line">            Node node = iter.next();</span><br><span class="line">            if (!this.client.ready(node, now)) &#123;</span><br><span class="line">                iter.remove();</span><br><span class="line">                notReadyTimeout = Math.min(notReadyTimeout, this.client.connectionDelay(node, now));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // è¿”å›è¯¥ node å¯¹åº”çš„æ‰€æœ‰å¯ä»¥å‘é€çš„ RecordBatch ç»„æˆçš„ batchesï¼ˆkey æ˜¯ node.idï¼‰,å¹¶å°† RecordBatch ä»å¯¹åº”çš„ queue ä¸­ç§»é™¤</span><br><span class="line">        Map&lt;Integer, List&lt;RecordBatch&gt;&gt; batches = this.accumulator.drain(cluster, result.readyNodes, this.maxRequestSize, now);</span><br><span class="line">        if (guaranteeMessageOrder) &#123;</span><br><span class="line">            //è®°å½•å°†è¦å‘é€çš„ RecordBatch</span><br><span class="line">            for (List&lt;RecordBatch&gt; batchList : batches.values()) &#123;</span><br><span class="line">                for (RecordBatch batch : batchList)</span><br><span class="line">                    this.accumulator.mutePartition(batch.topicPartition);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // å°†ç”±äºå…ƒæ•°æ®ä¸å¯ç”¨è€Œå¯¼è‡´å‘é€è¶…æ—¶çš„ RecordBatch ç§»é™¤</span><br><span class="line">        List&lt;RecordBatch&gt; expiredBatches = this.accumulator.abortExpiredBatches(this.requestTimeout, now);</span><br><span class="line">        for (RecordBatch expiredBatch : expiredBatches)</span><br><span class="line">            this.sensors.recordErrors(expiredBatch.topicPartition.topic(), expiredBatch.recordCount);</span><br><span class="line"></span><br><span class="line">        sensors.updateProduceRequestMetrics(batches);</span><br><span class="line"></span><br><span class="line">        long pollTimeout = Math.min(result.nextReadyCheckDelayMs, notReadyTimeout);</span><br><span class="line">        if (!result.readyNodes.isEmpty()) &#123;</span><br><span class="line">            log.trace(&quot;Nodes with data ready to send: &#123;&#125;&quot;, result.readyNodes);</span><br><span class="line">            pollTimeout = 0;</span><br><span class="line">        &#125;</span><br><span class="line">        // å‘é€ RecordBatch</span><br><span class="line">        sendProduceRequests(batches, now);</span><br><span class="line"></span><br><span class="line">        this.client.poll(pollTimeout, now); // å…³äº socket çš„ä¸€äº›å®é™…çš„è¯»å†™æ“ä½œï¼ˆå…¶ä¸­åŒ…æ‹¬ meta ä¿¡æ¯çš„æ›´æ–°ï¼‰</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç å‰é¢æœ‰å¾ˆå¤šæ˜¯å…¶ä»–çš„é€»è¾‘å¤„ç†ï¼Œå¦‚ï¼šç§»é™¤æš‚æ—¶ä¸å¯ç”¨çš„ nodeã€å¤„ç†ç”±äºå…ƒæ•°æ®ä¸å¯ç”¨å¯¼è‡´çš„è¶…æ—¶RecordBatchï¼ŒçœŸæ­£è¿›è¡Œå‘é€å‘é€RecordBatchçš„æ˜¯sendProduceRequests(batches, now)è¿™ä¸ªæ–¹æ³•ï¼Œå…·ä½“æ˜¯ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Transfer the record batches into a list of produce requests on a per-node basis</span><br><span class="line"> */</span><br><span class="line">private void sendProduceRequests(Map&lt;Integer, List&lt;RecordBatch&gt;&gt; collated, long now) &#123;</span><br><span class="line">    for (Map.Entry&lt;Integer, List&lt;RecordBatch&gt;&gt; entry : collated.entrySet())</span><br><span class="line">        sendProduceRequest(now, entry.getKey(), acks, requestTimeout, entry.getValue());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Create a produce request from the given record batches</span><br><span class="line"> */</span><br><span class="line">// å‘é€ produce è¯·æ±‚</span><br><span class="line">private void sendProduceRequest(long now, int destination, short acks, int timeout, List&lt;RecordBatch&gt; batches) &#123;</span><br><span class="line">    Map&lt;TopicPartition, MemoryRecords&gt; produceRecordsByPartition = new HashMap&lt;&gt;(batches.size());</span><br><span class="line">    final Map&lt;TopicPartition, RecordBatch&gt; recordsByPartition = new HashMap&lt;&gt;(batches.size());</span><br><span class="line">    for (RecordBatch batch : batches) &#123;</span><br><span class="line">        TopicPartition tp = batch.topicPartition;</span><br><span class="line">        produceRecordsByPartition.put(tp, batch.records());</span><br><span class="line">        recordsByPartition.put(tp, batch);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ProduceRequest.Builder requestBuilder =</span><br><span class="line">            new ProduceRequest.Builder(acks, timeout, produceRecordsByPartition);</span><br><span class="line">    RequestCompletionHandler callback = new RequestCompletionHandler() &#123;</span><br><span class="line">        public void onComplete(ClientResponse response) &#123;</span><br><span class="line">            handleProduceResponse(response, recordsByPartition, time.milliseconds());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    String nodeId = Integer.toString(destination);</span><br><span class="line">    ClientRequest clientRequest = client.newClientRequest(nodeId, requestBuilder, now, acks != 0, callback);</span><br><span class="line">    client.send(clientRequest, now);</span><br><span class="line">    log.trace(&quot;Sent produce request to &#123;&#125;: &#123;&#125;&quot;, nodeId, requestBuilder);</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç å°±ç®€å•å¾ˆå¤šï¼Œæ€»æ¥èµ·æ¥å°±æ˜¯ï¼Œå°† batches ä¸­ leader ä¸ºåŒä¸€ä¸ª node çš„æ‰€æœ‰ RecordBatch æ”¾åœ¨ä¸€ä¸ªè¯·æ±‚ä¸­è¿›è¡Œå‘é€ã€‚</p><h3 id="æœ€å"><a class="markdownIt-Anchor" href="#æœ€å"></a> æœ€å</h3><p>æœ¬æ–‡æ˜¯å¯¹ Kafka Producer ç«¯å‘é€æ¨¡å‹çš„ä¸€ä¸ªç®€å•åˆ†æï¼Œä¸‹ä¸€ç¯‡æ–‡ç« å°†ä¼šè¯¦ç»†ä»‹ç» metadata ç›¸å…³çš„å†…å®¹ï¼ŒåŒ…æ‹¬ metadata çš„å†…å®¹ä»¥åŠåœ¨ Producer ç«¯ metadata çš„æ›´æ–°æœºåˆ¶ã€‚</p><p>è½¬è‡ªï¼š<a href="https://zhuanlan.zhihu.com/p/66190242" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/66190242</a></p></div><div class="article-footer"><blockquote class="mt-2x"></blockquote><div class="panel panel-default panel-badger"><div class="panel-body"><figure class="media"><div class="media-left"><a href="https://github.com/Demo233" target="_blank" class="img-burn thumb-sm visible-lg"><img src="/images/avatar.jpg" class="img-rounded w-full" alt=""></a></div><div class="media-body"><h3 class="media-heading"><a href="https://github.com/Demo233" target="_blank"><span class="text-dark">zyh</span><small class="ml-1x"></small></a></h3><div>ä¸ªäººç®€ä»‹ã€‚</div></div></figure></div></div></div></article><section id="comments"></section></div><nav class="bar bar-footer clearfix" data-stick-bottom><div class="bar-inner"><ul class="pager pull-left"><li class="prev"><a href="/2020/11/26/2019-11-07-Kafkaæºç åˆ¨æä¹‹Produer Metadataæ›´æ–°æœºåˆ¶ï¼ˆäºŒï¼‰/" title="Kafkaæºç åˆ¨æä¹‹Produer Metadataæ›´æ–°æœºåˆ¶ï¼ˆäºŒï¼‰"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;Newer</span></a></li><li class="next"><a href="/2019/08/20/2019â€“08-20-ç¥ç»ç½‘ç»œï¼šåŸºæœ¬åˆ†ç±»[è½¬]/" title="ç¥ç»ç½‘ç»œï¼šåŸºæœ¬åˆ†ç±»[è½¬]"><span>Older&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a></li></ul><div class="bar-right"><div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,qzone"></div></div></div></nav></main><footer class="footer" itemscope itemtype="http://schema.org/WPFooter"><ul class="social-links"><li><a href="https://github.com/Demo233" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li><li><a href="https://www.weibo.com/u/5592904662/home" target="_blank" title="Weibo" data-toggle="tooltip" data-placement="top"><i class="icon icon-weibo"></i></a></li><li><a href="https://twitter.com/cnnqjban521" target="_blank" title="Twitter" data-toggle="tooltip" data-placement="top"><i class="icon icon-twitter"></i></a></li><li><a href="https://www.facebook.com/yihao.zhao.7" target="_blank" title="Facebook" data-toggle="tooltip" data-placement="top"><i class="icon icon-facebook"></i></a></li><li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li></ul><div class="copyright"><div class="publishby">Theme by <a href="https://github.com/cofess" target="_blank">cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.</div></div></footer><script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script><script>window.jQuery||document.write('<script src="js/jquery.min.js"><\/script>')</script><script src="/js/plugin.min.js"></script><script src="/js/application.js"></script><script>!function(T){var n={TRANSLATION:{POSTS:"Posts",PAGES:"Pages",CATEGORIES:"Categories",TAGS:"Tags",UNTITLED:"(Untitled)"},ROOT_URL:"/",CONTENT_URL:"/content.json"};T.INSIGHT_CONFIG=n}(window)</script><script src="/js/insight.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="//cdn.jsdelivr.net/npm/gitalk@1.4.0/dist/gitalk.min.js"></script><script src="//cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><script type="text/javascript">var gitalk=new Gitalk({clientID:"b6eff4e9fc3dae3c8764",clientSecret:"1d0201dabf2358e2f833a3b2e51b99126d85045a",repo:"Demo233.github.io",owner:"Demo233",admin:["Demo233"],id:md5(location.pathname),distractionFreeMode:!0});gitalk.render("comments")</script></body></html><!-- rebuild by neat -->